name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    runs-on: macos-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Update version in project
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        echo "Setting MARKETING_VERSION to $VERSION"
        sed -i '' "s/MARKETING_VERSION = .*/MARKETING_VERSION = $VERSION;/g" GitY.xcodeproj/project.pbxproj
    
    - name: Import signing certificate
      env:
        CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      run: |
        # Decode certificate
        echo $CERTIFICATE_BASE64 | base64 --decode > certificate.p12
        
        # Create temporary keychain
        security create-keychain -p "temp123" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "temp123" build.keychain
        
        # Import certificate
        security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple: -s -k "temp123" build.keychain
        
        # Clean up
        rm certificate.p12
    
    - name: Build application
      run: |
        xcodebuild -project GitY.xcodeproj \
          -scheme GitY \
          -configuration Release \
          -derivedDataPath build \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="Developer ID Application: Dongri Jin (${{ secrets.APPLE_TEAM_ID }})" \
          OTHER_CODE_SIGN_FLAGS="--timestamp --options=runtime" \
          build
        
        # Re-sign the app with correct entitlements (removes get-task-allow)
        codesign --force --deep --timestamp --options=runtime \
          --sign "Developer ID Application: Dongri Jin (${{ secrets.APPLE_TEAM_ID }})" \
          --entitlements Resources/GitY.entitlements \
          build/Build/Products/Release/GitY.app
    
    - name: Notarize application
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        # Create ZIP for notarization
        ditto -c -k --keepParent build/Build/Products/Release/GitY.app GitY-notarize.zip
        
        # Submit for notarization and wait for completion
        xcrun notarytool submit GitY-notarize.zip \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_PASSWORD" \
          --team-id "$TEAM_ID" \
          --wait \
          --output-format json > notarization_result.json || true
        
        # Check result and get log if failed
        STATUS=$(cat notarization_result.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('status', 'Unknown'))")
        SUBMISSION_ID=$(cat notarization_result.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))")
        
        echo "Notarization status: $STATUS"
        
        if [ "$STATUS" != "Accepted" ]; then
          echo "Notarization failed. Fetching log..."
          xcrun notarytool log "$SUBMISSION_ID" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$TEAM_ID" \
            notarization_log.json
          cat notarization_log.json
          exit 1
        fi
        
        # Staple the notarization ticket to the app
        xcrun stapler staple build/Build/Products/Release/GitY.app
        
        # Clean up
        rm GitY-notarize.zip notarization_result.json
    
    - name: Create DMG
      run: |
        # Create a temporary directory for DMG contents
        mkdir -p dmg_contents
        cp -R build/Build/Products/Release/GitY.app dmg_contents/
        
        # Create Applications symlink
        ln -s /Applications dmg_contents/Applications
        
        # Create DMG
        hdiutil create -volname "GitY" \
          -srcfolder dmg_contents \
          -ov -format UDZO \
          GitY.dmg
        
        # Also create a ZIP for convenience
        cd build/Build/Products/Release
        zip -r ../../../../GitY.zip GitY.app
    
    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: v${{ steps.version.outputs.version }}
        draft: false
        prerelease: false
        files: |
          GitY.dmg
          GitY.zip
        body: |
          ## GitY v${{ steps.version.outputs.version }}
          
          ### Installation (Recommended: Homebrew)
          ```bash
          brew install --cask dongri/tap/gity
          ```
          
          ### Manual Installation
          1. Download `GitY.dmg`
          2. Open the DMG file
          3. Drag GitY.app to Applications folder
          4. Double-click to launch! âœ¨
          
          > **Note**: GitY is signed and notarized by Apple, so it will launch without any security warnings.
          
          ### Command Line Tool
          After installing, open GitY and go to **Settings > Integration** to install the `gity` command line tool.
          
          ```bash
          gity .                    # Open current directory
          gity /path/to/repo        # Open specific repository
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Homebrew Cask
      if: startsWith(github.ref, 'refs/tags/')
      env:
        HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        SHA256=$(shasum -a 256 GitY.dmg | awk '{print $1}')
        
        git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/dongri/homebrew-tap.git
        cd homebrew-tap
        
        cat > Casks/gity.rb << 'CASKEOF'
        cask "gity" do
          version "VERSION_PLACEHOLDER"
          sha256 "SHA256_PLACEHOLDER"

          url "https://github.com/dongri/gity/releases/download/v#{version}/GitY.dmg"
          name "GitY"
          desc "A modern Git GUI client for macOS"
          homepage "https://github.com/dongri/gity"

          depends_on macos: ">= :ventura"

          app "GitY.app"

          zap trash: [
            "~/Library/Application Support/org.dongri.gity",
            "~/Library/Caches/org.dongri.gity",
            "~/Library/Preferences/org.dongri.gity.plist",
            "~/Library/Saved Application State/org.dongri.gity.savedState",
          ]
        end
        CASKEOF
        
        # Remove leading spaces from heredoc content
        sed -i '' 's/^        //' Casks/gity.rb
        
        # Replace placeholders with actual values
        sed -i '' "s/VERSION_PLACEHOLDER/${VERSION}/g" Casks/gity.rb
        sed -i '' "s/SHA256_PLACEHOLDER/${SHA256}/g" Casks/gity.rb
        
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add Casks/gity.rb
        git commit -m "Update gity to v${VERSION}"
        git push
    
    - name: Upload artifacts (for manual workflow)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.version.outputs.version }}
        path: |
          GitY.dmg
          GitY.zip
